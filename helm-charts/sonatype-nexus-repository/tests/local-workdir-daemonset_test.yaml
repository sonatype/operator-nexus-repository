suite: test creation of DaemonSet which creates the local work directory on each worker node when using a local Persistent Volume
templates:
  - local-workdir-daemonset.yaml
release:
  name: "test-release"
chart:
  version: "latest"
tests:
  - it: should create create local work directories when using a local Persistent Volume
    set:
      nexusData:
        local:
          enabled: true
        nfs:
          enabled: false
    asserts:
      - isKind:
          of: DaemonSet
      - equal:
          path: metadata.namespace
          value: "nexusrepo"
      - equal:
          path: metadata.name
          value: "nxrm-ha-latest-test-release-create-nexus-work-dir"

      - equal:
          path: spec.selector.matchLabels.job
          value: "dircreator"

      - equal:
          path: spec.template.metadata.labels.job
          value: "dircreator"

      - equal:
          path: spec.template.spec.hostPID
          value: true

      - equal:
          path: spec.template.spec.restartPolicy
          value: Always


      - equal:
          path: spec.template.spec.initContainers[0].name
          value: create-nexus-work-dir

      - equal:
          path: spec.template.spec.initContainers[0].image
          value: ubuntu:23.04

      - equal:
          path: spec.template.spec.initContainers[0].command
          value: [/bin/sh]

      - equal:
          path: spec.template.spec.initContainers[0].args
          value:
            - -c
            - >-
              cp /tmp/create-nexus-work-dir.sh /host-dir && 
              /usr/bin/nsenter -m/proc/1/ns/mnt -- chmod u+x /tmp/install/create-nexus-work-dir.sh && 
              /usr/bin/nsenter -m/proc/1/ns/mnt /tmp/install/create-nexus-work-dir.sh

      - equal:
          path: spec.template.spec.initContainers[0].securityContext.privileged
          value: true


      - equal:
          path: spec.template.spec.initContainers[0].volumeMounts
          value:
            - name: create-nexus-work-dir-script
              mountPath: /tmp
            - name: host-mnt
              mountPath: /host-dir